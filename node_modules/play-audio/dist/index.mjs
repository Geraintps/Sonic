var B=Object.defineProperty;var a=(s,e)=>B(s,"name",{value:e,configurable:!0}),g=(s=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(s,{get:(e,t)=>(typeof require!="undefined"?require:e)[t]}):s)(function(s){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+s+'" is not supported')});import{Duplex as v}from"stream";var _=class{constructor(e){let t=g("play-opus");this.options=e,this.encoder=new t.OpusHandler(e.rate,e.channels)}encode(e){return this.encoder.encode(e)}decode(e){return this.encoder.decode(e)}encode_ctl(e,t){this.encode_ctl(e,t)}decode_ctl(e,t){this.decode_ctl(e,t)}delete(){this.encoder.delete()}};a(_,"OpusHandler");var O=class{constructor(e){let t=g("opusscript");this.options=e,this.encoder=new t(e.rate,e.channels)}encode(e){return this.encoder.encode(e,this.options.frameSize)}decode(e){return this.encoder.decode(e)}encode_ctl(e,t){this.encode_ctl(e,t)}decode_ctl(e,t){this.decode_ctl(e,t)}delete(){this.encoder.delete()}};a(O,"OpusHandler");var x={"play-opus":s=>new _(s),opusscript:s=>new O(s)};function E(s,e){if(e){if(e!=="opusscript"&&e!=="play-opus")return new Error(`Supported modules for play-media :
- play-opus
- opusscript`);try{g(e)}catch{return new Error(`Module [${e}] Not Found.`)}return x[e](s)}else{for(let[t,r]of Object.entries(x))try{return g(t),r(s)}catch{continue}return new Error(`No modules found. Try to install one of following :
- play-opus
- opusscript`)}}a(E,"createOpusHandler");var f=class extends v{constructor(e){super(e.duplex);let t=E(e,e.encoder);if(t instanceof Error)throw t;this.encoder=t,this.pcm_length=e.frameSize*e.channels*2}encode(e){return this.encoder.encode(e)}decode(e){return this.encoder.decode(e)}cleanup(){this.encoder.delete()}_read(){}_destroy(e,t){this.cleanup(),t(e)}_final(e){this.cleanup(),this.push(null),e()}bitrate(e){return this.applyCTL(4002,e)}setFEC(e){return this.applyCTL(4012,e?1:0)}setPLP(e){return this.applyCTL(4014,Math.min(100,Math.max(0,e*100)))}};a(f,"OpusDuplexStream");var b=class extends f{constructor(e){super(e);this.remaining=Buffer.allocUnsafe(0)}_write(e,t,r){let n=Buffer.concat([this.remaining,e]),o=0;for(;n.length>=o+this.pcm_length;){let d=n.slice(o,o+this.pcm_length),p;try{p=this.encode(d)}catch(l){r(l);return}this.push(p),o+=this.pcm_length}o>0&&(this.remaining=n.slice(o)),r()}applyCTL(e,t){this.encoder.encode_ctl(e,t)}};a(b,"OpusEncoder");var S=Buffer.from("OpusHead"),H=Buffer.from("OpusTags"),y=class extends f{constructor(e){super(e)}_write(e,t,r){if(e.compare(S,0,8,0,8)===0)this.opusHead=e,this.emit("opusHead",e);else if(e.compare(H,0,8,0,8)===0)this.opusTags=e,this.emit("opusTags",e);else{let n;try{n=this.encoder.decode(e)}catch(o){r(o);return}this.push(n)}r()}applyCTL(e,t){this.encoder.decode_ctl(e,t)}};a(y,"OpusDecoder");import{Duplex as w}from"stream";var P=26,D=0,z=Buffer.from("OggS"),A=Buffer.from("OpusHead"),C=Buffer.from("OpusTags"),k=class extends w{constructor(e){super(e)}_read(){}_write(e,t,r){for(this.remaining&&(e=Buffer.concat([this.remaining,e]),this.remaining=void 0);;){let n=this.readOggPage(e);if(n)n instanceof Error?r(n):e=n;else break}this.remaining=e,this.ogg_head=void 0,r()}readOggPage(e){if(this.ogg_head)return this.readOggData(e);{let t=this.readOggHead(e);return t?t instanceof Error?t:this.readOggData(t):!1}}readOggData(e){if(!this.ogg_head||e.length<this.ogg_head.totalSize)return!1;let t=0;for(let r of this.ogg_head.sizes){let n=e.slice(t,t+r);if(this.opus_head)r>=8&&n.compare(C,0,8,0,8)===0?this.emit("tags",n):this.push(n);else if(n.compare(A,0,8,0,8)===0)this.emit("head",n),this.opus_head=n;else return new Error("Unknown Segment Found");t+=r}return this.ogg_head=void 0,e.slice(t)}readOggHead(e){if(e.length<P)return!1;if(e.compare(z,0,4,0,4)!==0)return new Error("Capture Pattern is not OggS");if(e.readUInt8(4)!==D)return new Error("OGG version is not equal to 0.");if(e.length<27)return!1;let t=e.readUInt8(26);if(e.length<27+t)return!1;let r=e.slice(27,27+t),n=[],o=0;for(let d=0;d<t;){let p=0,l=255;for(;l===255;){if(d>=r.length)return!1;l=r.readUInt8(d),d++,p+=l}n.push(p),o+=p}return this.ogg_head={sizes:n,totalSize:o,pageSegments:t},e.slice(27+t)}_destroy(e,t){this._cleanup(),t(e)}_final(e){this._cleanup(),this.push(null),e()}_cleanup(){this.remaining=void 0,this.opus_head=void 0,this.ogg_head=void 0}};a(k,"OggDemuxer");import{Duplex as L}from"stream";var i={string:s=>s.toString("utf-8"),uint:s=>parseInt(s.toString("hex"),16),float:s=>parseFloat(s.toString("utf-8"))},h={"1a45dfa3":{name:"ebml",type:0},"4286":{name:"ebmlVersion",type:2,return:i.uint},"42f7":{name:"ebmlReadVersion",type:2,return:i.uint},"42f2":{name:"ebmlMaxIDLength",type:2,return:i.uint},"42f3":{name:"ebmlMaxSizeLength",type:2,return:i.uint},"4282":{name:"docType",type:1,return:i.string},"4287":{name:"docTypeVersion",type:2,return:i.uint},"4285":{name:"docTypeReadVersion",type:2,return:i.uint},"18538067":{name:"segment",type:0},"114d9b74":{name:"seekHead",type:0},"4dbb":{name:"seek",type:0},"53ab":{name:"seekId",type:3},"53ac":{name:"seekPosition",type:2,return:i.uint},"1549a966":{name:"info",type:0},"4489":{name:"duration",type:4,return:i.float},"4d80":{name:"muxingApp",type:1,return:i.string},"5741":{name:"writingApp",type:1,return:i.string},"1f43b675":{name:"cluster",type:0},e7:{name:"clusterTimecode",type:2,return:i.uint},a3:{name:"simpleBlock",type:3},"1654ae6b":{name:"tracks",type:0},ae:{name:"trackEntry",type:0},d7:{name:"trackNumber",type:2,return:i.uint},"83":{name:"trackType",type:2,return:i.uint},"86":{name:"codecID",type:1,return:i.string},e1:{name:"audio",type:0},b5:{name:"samplingFrequency",type:4,return:i.float},"9f":{name:"channels",type:2,return:i.uint},"6264":{name:"bitDepth",type:2,return:i.uint},"1c53bb6b":{name:"cues",type:0},bb:{name:"cuePoint",type:0},b3:{name:"cueTime",type:2,return:i.uint},b7:{name:"cueTrackPositions",type:0},f7:{name:"cueTrack",type:2,return:i.uint},f1:{name:"cueClusterPosition",type:2,return:i.uint}};var m=class{constructor(){this.ebml={},this.segment={},this.audioTrack=-1}parse(e,t){switch(e.name){case"ebml":this.ebml={};break;case"ebmlVersion":e.return&&(this.ebml.version=e.return(t));break;case"ebmlReadVersion":e.return&&(this.ebml.readVersion=e.return(t));break;case"ebmlMaxIDLength":e.return&&(this.ebml.maxIDLength=e.return(t));break;case"ebmlMaxSizeLength":e.return&&(this.ebml.maxSizeWidth=e.return(t));break;case"docType":if(e.return){let r=e.return(t);if(r!=="webm")return new Error("This is not a Webm Stream. [ DocType !== webm ]");this.ebml.docType=r}break;case"docTypeVersion":e.return&&(this.ebml.docTypeVersion=e.return(t));break;case"docTypeReadVersion":e.return&&(this.ebml.docTypeReadVersion=e.return(t));break;case"segment":this.segment={};break;case"seekHead":this.segment.seekHead=[];break;case"seekPosition":e.return&&this.segment.seekHead.push({position:e.return(t)});break;case"info":this.segment.info={};break;case"duration":e.return&&(this.segment.info.duration=e.return(t));break;case"muxingApp":e.return&&(this.segment.info.muxingApp=e.return(t));break;case"writingApp":e.return&&(this.segment.info.writingApp=e.return(t));break;case"cluster":this.segment.cluster={};break;case"clusterTimecode":e.return&&(this.segment.cluster.time=e.return(t));break;case"simpleBlock":break;case"tracks":this.segment.tracks=[];break;case"trackEntry":this.segment.tracks.push({});break;case"trackNumber":e.return&&(this.segment.tracks[this.segment.tracks.length-1].trackNumber=e.return(t));break;case"trackType":if(e.return){let r=e.return(t);r===2&&(this.audioTrack=this.segment.tracks.length-1),this.segment.tracks[this.segment.tracks.length-1].trackType=r}break;case"codecID":if(e.return){let r=e.return(t);if(r!=="A_OPUS"&&this.segment.tracks[this.segment.tracks.length-1].trackType===2)return new Error("Audio Codec is not OPUS");this.segment.tracks[this.segment.tracks.length-1].codecID=r}break;case"audio":this.segment.tracks[this.segment.tracks.length-1].audio={};break;case"samplingFrequency":e.return&&(this.segment.tracks[this.segment.tracks.length-1].audio.rate=e.return(t));break;case"channels":e.return&&(this.segment.tracks[this.segment.tracks.length-1].audio.channels=e.return(t));break;case"bitDepth":e.return&&(this.segment.tracks[this.segment.tracks.length-1].audio.bitDepth=e.return(t));break;case"cues":this.segment.cues=[];break;case"cuePoint":this.segment.cues.push({});break;case"cueTime":e.return&&(this.segment.cues[this.segment.cues.length-1].time=e.return(t));break;case"cueTrack":e.return&&(this.segment.cues[this.segment.cues.length-1].track=e.return(t));break;case"cueClusterPosition":e.return&&(this.segment.cues[this.segment.cues.length-1].position=e.return(t));break;default:break}}};a(m,"WebmHeader");var T=class extends L{constructor(e){super(e);this.cursor=0,this.header=new m,this.headfound=!1,this.data_length=0,this.data_size=0}get vint_length(){let e=0;for(;e<8&&!(1<<7-e&this.chunk[this.cursor]);e++);return++e}get vint_value(){if(!this.chunk)return!1;let e=this.vint_length;if(this.chunk.length<this.cursor+e)return!1;let t=this.chunk[this.cursor]&(1<<8-e)-1;for(let r=this.cursor+1;r<this.cursor+e;r++)t=(t<<8)+this.chunk[r];return this.data_size=e,this.data_length=t,!0}cleanup(){this.cursor=0,this.chunk=void 0,this.remaining=void 0}_read(){}_write(e,t,r){this.remaining?(this.chunk=Buffer.concat([this.remaining,e]),this.remaining=void 0):this.chunk=e;let n=this.readTag();n instanceof Error?r(n):r()}readTag(){if(!this.chunk)return new Error("Chunk is missing");for(;this.chunk.length>this.cursor;){let e=this.cursor,t=this.vint_length;if(this.chunk.length<this.cursor+t)break;let r=this.parseEbmlID(this.chunk.slice(this.cursor,this.cursor+t).toString("hex"));if(this.cursor+=t,!this.vint_value){this.cursor=e;break}if(!r){this.cursor+=this.data_size+this.data_length;continue}if(!this.headfound)if(r.name==="ebml")this.headfound=!0;else return new Error("Failed to find EBML ID at start of stream.");let o=this.chunk.slice(this.cursor+this.data_size,this.cursor+this.data_size+this.data_length),d=this.header.parse(r,o);if(d instanceof Error)return d;if(r.type===0){this.cursor+=this.data_size;continue}if(this.chunk.length<this.cursor+this.data_size+this.data_length){this.cursor=e;break}else this.cursor+=this.data_size+this.data_length;if(r.name==="simpleBlock"){let p=this.header.segment.tracks[this.header.audioTrack];if(!p||p.trackType!==2)return new Error("No audio Track in this webm file.");(o[0]&15)===p.trackNumber&&this.push(o.slice(4))}}this.remaining=this.chunk.slice(this.cursor),this.cursor=0}parseEbmlID(e){return Object.keys(h).includes(e)?h[e]:!1}_destroy(e,t){this.cleanup(),t(e)}_final(e){this.cleanup(),this.push(null),e()}};a(T,"WebmDemuxer");var Oe={OpusDecoder:y,OggDemuxer:k,OpusEncoder:b,WebmDemuxer:T,WebmHeader:m,WebmElements:h};export{k as OggDemuxer,y as OpusDecoder,b as OpusEncoder,T as WebmDemuxer,h as WebmElements,m as WebmHeader,Oe as default};
//# sourceMappingURL=index.mjs.map